#!/sbin/nft -f

flush ruleset

table inet dualstack {
	chain ee {
		ip daddr 82.192.97.153/32 tcp dport 443 reject
		ip daddr 82.192.97.153/32 tcp dport 80 accept

		ip6 daddr 64:ff9b::52c0:6199/128 tcp dport 443 reject
		ip6 daddr 64:ff9b::52c0:6199/128 tcp dport 80 accept
	}

	chain port80 {
		ip daddr 34.107.221.82/32 accept comment "detectportal.firefox.com"
		ip6 daddr 2600:1901:0000:38d7::/128 accept comment "detectportal.firefox.com"
	}

	chain port5353 {
		ip  daddr 224.0.0.251/32 accept
		ip6 daddr ff02::fb/128   accept
	}

	chain port5355 {
		ip  daddr 224.0.0.252/32 accept
		ip6 daddr ff02::1:3/128  accept
	}

	chain new {
		oifname wwan0 jump ee
		tcp dport 80 limit rate 1/second jump port80

		meta l4proto { tcp, udp } th dport { 53, 443 } accept
		udp dport { 123 } accept
		tcp dport { 22 } accept

		ip daddr 224.0.0.22/32 meta l4proto igmp accept
		ip6 daddr 2001:8b0:c09::/48 udp dport 623 accept comment "ipmi"

		tcp dport 4242  accept comment "quassel"
		tcp dport 5222  accept comment "xmpp"
		tcp dport 32400 accept comment "plex"

		meta protocol ip udp dport 67 accept comment "dhcp"
		oifname wlp0s12f0 udp dport 5353 jump port5353
		oifname wlp0s12f0 udp dport 5355 jump port5355
	}

	chain output {
		type filter hook output priority filter; policy drop;
		jump common_accept;

		ct state new jump new

		jump common_reject
	}

	chain common_accept {
		iif "lo" accept comment "Accept incoming localhost traffic"
		oif "lo" accept comment "Accept outgoing localhost traffic"

		icmp type echo-request ct state new accept
		meta l4proto ipv6-icmp accept

		ct state invalid drop comment "Drop invalid connections"
		ct state established,related accept comment "Accept existing traffic"
	}

	chain common_reject {
		meta l4proto udp reject
		meta l4proto tcp reject with tcp reset
		reject
	}

	chain input {
		type filter hook input priority filter; policy drop;
		jump common_accept

		iifname wlp0s12f0 udp dport { 5353, 5355 } accept
		udp dport { 6666, 6667 } reject

		jump common_reject
	}

	chain forward {
		type filter hook forward priority filter; policy drop;
		jump common_accept
		jump common_reject
	}
}
